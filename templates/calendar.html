<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>D3NTAL TECH - Calendrier</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style_v2.css') }}">
</head>

<body>

    <!-- TOPBAR -->
    <div class="topbar">
        <div class="topbar-title">D3NTAL TECH</div>
        <a class="topbar-logout" href="/logout">Déconnexion</a>
    </div>

    <!-- CONTAINER -->
    <div class="container">

        <!-- NAVIGATION CALENDRIER -->
        <div class="calendar-nav">
            <a class="nav-btn" href="/calendar?year={{ prev_year }}&month={{ prev_month }}">← Mois précédent</a>

            <h2>{{ month_name }} {{ year }}</h2>

            <a class="nav-btn" href="/calendar?year={{ next_year }}&month={{ next_month }}">Mois suivant →</a>
        </div>

        <!-- BOUTON AJOUT -->
        <div class="add-wrapper">
            <a href="#" id="openModalBtn" class="nav-btn add-btn">
                + Ajouter un événement
            </a>
        </div>

        <!-- TABLE CALENDRIER -->
        <table class="calendar">
            <tr>
                <th>Lundi</th>
                <th>Mardi</th>
                <th>Mercredi</th>
                <th>Jeudi</th>
                <th>Vendredi</th>
                <th>Samedi</th>
                <th>Dimanche</th>
            </tr>

            {% for week in calendar_days %}
            <tr>
                {% for day in week %}
                {% set is_other = (day.month != month) %}
                {% set is_today = (day == current_day) %}
                {% set day_key = day.isoformat() %}
                {% set day_events = events_by_date.get(day_key, []) %}

                <td class="{% if is_other %}other-month{% endif %}{% if is_today %} today{% endif %}">
                    <div class="day-number">{{ day.day }}</div>

                    {% for ev in day_events %}
                    <div class="event-badge event-type-{{ ev.css_class }}"
                         data-event-id="{{ ev.id }}"
                         data-event-title="{{ ev.title }}"
                         data-event-date="{{ ev.date }}"
                         data-event-time="{{ ev.time }}"
                         data-event-type="{{ ev.type }}"
                         data-event-collaborators="{{ ev.collaborators }}">
                        <div class="event-line">
                            <span class="event-time">{{ ev.time }}</span>
                            <span class="event-title">{{ ev.title }}</span>
                        </div>
                        <div class="event-meta">
                            {{ ev.type }}
                            {% if ev.collaborators %}
                                — {{ ev.collaborators }}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </table>
    </div>

    <!-- MODALE AJOUT / EDIT -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-box">
            <span class="close-btn" id="closeModalBtn">&times;</span>
            <h3 id="modalTitle">Ajouter un événement</h3>

            <div id="errorMessageModal" class="error" style="display:none;"></div>

            <input id="eventTitle" type="text" placeholder="Titre de l’événement">
            <input id="eventDate" type="date">
            <input id="eventTime" type="time">

            <select id="eventType">
                <option value="Rendez-vous patient">Rendez-vous patient</option>
                <option value="Réunion interne">Réunion interne</option>
                <option value="Administration">Administration</option>
                <option value="Urgence cabinet">Urgence cabinet</option>
                <option value="Formation">Formation</option>
                <option value="Autre">Autre</option>
            </select>

            <input id="eventTypeCustom" type="text" placeholder="Précisez le type (Autre)" style="display:none;">

            <div class="collab-title">Collaborateurs :</div>
            <div class="collab-group">
                <label><input type="checkbox" class="collab-checkbox" value="Denis"> Denis</label>
                <label><input type="checkbox" class="collab-checkbox" value="Isis"> Isis</label>
                <label><input type="checkbox" class="collab-checkbox" value="Assistante"> Assistante</label>
                <label><input type="checkbox" class="collab-checkbox" id="collabOtherCheckbox" value="__AUTRE__"> Autre</label>
            </div>

            <input id="eventCollaboratorsOther" type="text" placeholder="Autre collaborateur" style="display:none;">

            <button id="saveEventBtn">Enregistrer</button>
            <button id="deleteEventBtn" class="delete-btn" style="display:none;">Supprimer</button>
        </div>
    </div>

    <!-- SCRIPT JS -->
    <script>
        const modalOverlay = document.getElementById("modalOverlay");
        const openModalBtn = document.getElementById("openModalBtn");
        const closeModalBtn = document.getElementById("closeModalBtn");

        const titleInput = document.getElementById("eventTitle");
        const dateInput = document.getElementById("eventDate");
        const timeInput = document.getElementById("eventTime");
        const typeSelect = document.getElementById("eventType");
        const typeCustomInput = document.getElementById("eventTypeCustom");

        const collabOtherCheckbox = document.getElementById("collabOtherCheckbox");
        const collabOtherInput = document.getElementById("eventCollaboratorsOther");

        const saveBtn = document.getElementById("saveEventBtn");
        const deleteBtn = document.getElementById("deleteEventBtn");

        let editingEventId = null;

        // Affiche le picker natif au clic (si dispo)
        if (dateInput && dateInput.showPicker) {
            dateInput.addEventListener("click", () => dateInput.showPicker());
        }
        if (timeInput && timeInput.showPicker) {
            timeInput.addEventListener("click", () => timeInput.showPicker());
        }

        function resetModal() {
            editingEventId = null;
            document.getElementById("modalTitle").innerText = "Ajouter un événement";
            saveBtn.textContent = "Enregistrer";
            deleteBtn.style.display = "none";

            titleInput.value = "";
            dateInput.value = "";
            timeInput.value = "";
            typeSelect.value = "Rendez-vous patient";
            typeCustomInput.style.display = "none";
            typeCustomInput.value = "";

            document.querySelectorAll(".collab-checkbox").forEach(cb => cb.checked = false);
            collabOtherInput.style.display = "none";
            collabOtherInput.value = "";
            collabOtherCheckbox.checked = false;
        }

        // OUVERTURE MODALE (ajout)
        openModalBtn.onclick = (e) => {
            e.preventDefault();
            resetModal();
            modalOverlay.style.display = "flex";
        };

        // FERMETURE
        closeModalBtn.onclick = () => {
            modalOverlay.style.display = "none";
        };
        modalOverlay.onclick = (e) => {
            if (e.target === modalOverlay) {
                modalOverlay.style.display = "none";
            }
        };

        // TYPE "Autre"
        typeSelect.onchange = () => {
            if (typeSelect.value === "Autre") {
                typeCustomInput.style.display = "block";
            } else {
                typeCustomInput.style.display = "none";
                typeCustomInput.value = "";
            }
        };

        // COLLAB "Autre"
        collabOtherCheckbox.onchange = () => {
            if (collabOtherCheckbox.checked) {
                collabOtherInput.style.display = "block";
            } else {
                collabOtherInput.style.display = "none";
                collabOtherInput.value = "";
            }
        };

        // CLICK SUR UN ÉVÉNEMENT = EDIT
        document.querySelectorAll(".event-badge").forEach(badge => {
            badge.onclick = () => {
                editingEventId = badge.dataset.eventId;
                document.getElementById("modalTitle").innerText = "Modifier l’événement";
                saveBtn.textContent = "Mettre à jour";
                deleteBtn.style.display = "block";
                modalOverlay.style.display = "flex";

                titleInput.value = badge.dataset.eventTitle || "";
                dateInput.value = badge.dataset.eventDate || "";
                timeInput.value = badge.dataset.eventTime || "";

                const type = badge.dataset.eventType || "";
                const known = [
                    "Rendez-vous patient",
                    "Réunion interne",
                    "Administration",
                    "Urgence cabinet",
                    "Formation"
                ];

                if (known.includes(type)) {
                    typeSelect.value = type;
                    typeCustomInput.style.display = "none";
                    typeCustomInput.value = "";
                } else if (type) {
                    typeSelect.value = "Autre";
                    typeCustomInput.style.display = "block";
                    typeCustomInput.value = type;
                } else {
                    typeSelect.value = "Rendez-vous patient";
                    typeCustomInput.style.display = "none";
                    typeCustomInput.value = "";
                }

                // Reset collabs
                document.querySelectorAll(".collab-checkbox").forEach(cb => cb.checked = false);
                collabOtherInput.style.display = "none";
                collabOtherInput.value = "";
                collabOtherCheckbox.checked = false;

                const raw = (badge.dataset.eventCollaborators || "").split(",").map(v => v.trim()).filter(v => v);
                let others = [];

                raw.forEach(val => {
                    const lower = val.toLowerCase();
                    if (lower.includes("denis")) {
                        document.querySelector('input[value="Denis"]').checked = true;
                    } else if (lower.includes("isis")) {
                        document.querySelector('input[value="Isis"]').checked = true;
                    } else if (lower.includes("assist")) {
                        document.querySelector('input[value="Assistante"]').checked = true;
                    } else {
                        others.push(val);
                    }
                });

                if (others.length > 0) {
                    collabOtherCheckbox.checked = true;
                    collabOtherInput.style.display = "block";
                    collabOtherInput.value = others.join(", ");
                }
            };
        });

        // SAUVEGARDE (AJOUT / UPDATE)
        saveBtn.onclick = async () => {
            let collaborators = [];
            document.querySelectorAll(".collab-checkbox").forEach(cb => {
                if (cb.checked && cb.value !== "__AUTRE__") {
                    collaborators.push(cb.value);
                }
            });
            if (collabOtherCheckbox.checked && collabOtherInput.value.trim()) {
                collaborators.push(collabOtherInput.value.trim());
            }

            let eventType = typeSelect.value;
            if (eventType === "Autre") {
                eventType = typeCustomInput.value.trim();
            }

            const payload = {
                title: titleInput.value.trim(),
                event_date: dateInput.value,
                event_time: timeInput.value,
                event_type: eventType,
                collaborators: collaborators.join(", ")
            };

            if (!payload.title || !payload.event_date || !payload.event_time || !payload.event_type) {
                alert("Veuillez remplir tous les champs.");
                return;
            }

            let url = "/api/add_event";
            if (editingEventId) {
                payload.event_id = editingEventId;
                url = "/api/update_event";
            }

            const res = await fetch(url, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            });

            const data = await res.json();
            if (data.status === "success") {
                window.location.reload();
            } else {
                alert("Erreur : " + (data.message || "inconnue"));
            }
        };

        // SUPPRESSION
        deleteBtn.onclick = async () => {
            if (!editingEventId) return;
            if (!confirm("Supprimer cet événement ?")) return;

            const res = await fetch("/api/delete_event", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ event_id: editingEventId })
            });

            const data = await res.json();
            if (data.status === "success") {
                window.location.reload();
            } else {
                alert("Erreur lors de la suppression.");
            }
        };
    </script>

</body>
</html>
