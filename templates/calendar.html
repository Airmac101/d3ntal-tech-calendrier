<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>D3NTAL TECH - Calendrier</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style_v3.css') }}?v=3">
</head>

<body>

    <!-- TOPBAR -->
    <div class="topbar">
        <div class="topbar-title">D3NTAL TECH</div>
        <a class="topbar-logout" href="/logout">D√©connexion</a>
    </div>

    <!-- CONTAINER -->
    <div class="container">

        <!-- NAVIGATION CALENDRIER -->
        <div class="calendar-nav">
            <a class="nav-btn" href="/calendar?year={{ prev_year }}&month={{ prev_month }}">‚Üê Mois pr√©c√©dent</a>

            <h2>{{ month_name }} {{ year }}</h2>

            <a class="nav-btn" href="/calendar?year={{ next_year }}&month={{ next_month }}">Mois suivant ‚Üí</a>
        </div>

        <!-- BOUTON AJOUT -->
        <div class="add-wrapper">
            <a href="#" id="openModalBtn" class="nav-btn add-btn">
                + Ajouter un √©v√©nement
            </a>
        </div>

        <!-- TABLE CALENDRIER -->
        <table class="calendar">
            <tr>
                <th>Lundi</th>
                <th>Mardi</th>
                <th>Mercredi</th>
                <th>Jeudi</th>
                <th>Vendredi</th>
                <th>Samedi</th>
                <th>Dimanche</th>
            </tr>

            {% for week in calendar_days %}
            <tr>
                {% for day in week %}
                {% set is_other = (day.month != month) %}
                {% set is_today = (day == current_day) %}
                {% set day_key = day.isoformat() %}
                {% set day_events = events_by_date.get(day_key, []) %}

                <td class="calendar-day{% if is_other %} other-month{% endif %}{% if is_today %} today{% endif %}"
                    data-date="{{ day_key }}">
                    <div class="day-number">{{ day.day }}</div>

                    {% for ev in day_events %}
                        {% set display_time = 'Journ√©e enti√®re' if ev.time == '00:00' else ev.time %}
                    <div class="event-badge event-type-{{ ev.css_class }}"
                         data-event-id="{{ ev.id }}"
                         data-event-title="{{ ev.title }}"
                         data-event-date="{{ ev.date }}"
                         data-event-time="{{ ev.time }}"
                         data-event-type="{{ ev.type }}"
                         data-event-priority="{{ ev.priority }}"
                         data-event-notes="{{ ev.notes }}"
                         data-event-collaborators="{{ ev.collaborators }}"
                         data-event-files='{{ ev.files|default([])|tojson }}'>
                        <div class="event-line">
                            <span class="event-time">{{ display_time }}</span>
                            <span class="event-title">{{ ev.title }}</span>
                        </div>
                        <div class="event-meta">
                            {{ ev.type }}
                            {% if ev.collaborators %}
                                ‚Äî {{ ev.collaborators }}
                            {% endif %}
                        </div>
                        {% set files = ev.files|default([]) %}
                        {% if files %}
                            {% set file_count = files|length %}
                            {% if file_count > 0 %}
                                <div class="event-files-summary">
                                    üìé Pi√®ces jointes ({{ file_count }})
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                    {% endfor %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </table>

        <!-- R√âCAPITULATIF DU MOIS -->
        <div class="weekly-summary-box">
            <h3>R√©capitulatif du mois :
                {{ week_start.strftime('%d/%m/%Y') }} ‚Üí {{ week_end.strftime('%d/%m/%Y') }}
            </h3>

            <div class="weekly-summary-list">
                {% if week_summary|length == 0 %}
                    <div class="week-line">
                        <span class="week-none">Aucun √©v√©nement enregistr√© pour ce mois.</span>
                    </div>
                {% else %}
                    {% for day_key, d in week_summary.items()|sort(attribute='1.date') %}
                        <div class="week-line">
                            <span class="week-day">
                                {{ d.date.strftime('%A %d %B').capitalize() }} :
                            </span>

                            {% if d.events|length == 0 %}
                                <span class="week-none">‚Äî</span>
                            {% else %}
                                {% for ev in d.events %}
                                    {% set label_time = 'Journ√©e enti√®re' if ev.time == '00:00' else ev.time %}
                                    <span class="week-event">
                                        <span class="priority priority-{{ ev.priority|lower }}">
                                            [{{ ev.priority|upper }}]
                                        </span>
                                        {{ label_time }} ‚Äî {{ ev.type }} ‚Äî {{ ev.title }}
                                        {% if ev.collab %}
                                            ({{ ev.collab }})
                                        {% endif %}
                                        {% if ev.notes %}
                                            ‚Äî <em>{{ ev.notes }}</em>
                                        {% endif %}
                                    </span>
                                    {% if not loop.last %} | {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>

    </div>

    <!-- MODALE AJOUT / EDIT -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-box" id="modalBox">
            <span class="close-btn" id="closeModalBtn">&times;</span>
            <h3 id="modalTitle">Ajouter un √©v√©nement</h3>

            <div id="errorMessageModal" class="error" style="display:none;"></div>

            <!-- TITRE -->
            <input id="eventTitle" type="text" placeholder="Titre de l‚Äô√©v√©nement">

            <!-- DATE -->
            <input id="eventDate" type="date">

            <!-- HEURE -->
            <input id="eventTime" type="time">

            <!-- JOURN√âE ENTI√àRE -->
            <label style="margin-top:8px; display:block;">
                <input type="checkbox" id="allDayCheckbox">
                Journ√©e enti√®re (sans pr√©ciser d‚Äôheure)
            </label>

            <!-- TYPE -->
            <select id="eventType">
                <option value="Rendez-vous Client">Rendez-vous Client</option>
                <option value="Rendez-vous Fournisseur">Rendez-vous Fournisseur</option>
                <option value="R√©union interne">R√©union interne</option>
                <option value="Administration">Administration</option>
                <option value="Urgence cabinet">Urgence cabinet</option>
                <option value="Formation">Formation</option>
                <option value="Autre">Autre</option>
            </select>

            <input id="eventTypeCustom" type="text" placeholder="Pr√©cisez le type (Autre)" style="display:none;">

            <!-- COLLABORATEURS -->
            <div class="collab-title">Collaborateurs :</div>

            <div class="collab-group">

                <label><input type="checkbox" class="collab-checkbox" value="Denis"> Denis</label>
                <label><input type="checkbox" class="collab-checkbox" value="Isis"> Isis</label>
                <label><input type="checkbox" class="collab-checkbox" value="Assistante"> Assistante</label>
                <label><input type="checkbox" class="collab-checkbox" id="collabOtherCheckbox" value="__AUTRE__"> Autre</label>

            </div>

            <input id="eventCollaboratorsOther" type="text" placeholder="Autre collaborateur" style="display:none;">

            <!-- PRIORIT√â -->
            <select id="eventPriority">
                <option value="Normal" selected>Normal</option>
                <option value="Urgent">Urgent</option>
                <option value="Important">Important</option>
                <option value="Critique">Critique</option>
            </select>

            <!-- NOTES -->
            <textarea id="eventNotes" rows="6" placeholder="Informations suppl√©mentaires..."
                class="notes-textarea"></textarea>

            <!-- FICHIERS JOINTS EXISTANTS -->
            <div id="existingFilesContainer" class="files-list" style="margin-top:8px; display:none;"></div>

            <!-- AJOUT DE NOUVELLES PI√àCES JOINTES -->
            <label style="margin-top:8px; display:block;">
                Pi√®ces jointes :
                <input id="eventFiles" type="file" multiple>
            </label>

            <button id="saveEventBtn">Enregistrer</button>
            <button id="deleteEventBtn" class="delete-btn" style="display:none;">Supprimer</button>
        </div>
    </div>

    <!-- MENU CONTEXTUEL JOUR -->
    <div id="dayContextMenu" class="context-menu" style="display:none;"></div>

    <!-- SCRIPT JS ‚Äî IDENTIQUE, NON MODIFI√â -->
    <script>
        /* (script complet non modifi√© ‚Äî le tien √©tait correct) */
        /* ... */
    </script>

</body>
</html>
